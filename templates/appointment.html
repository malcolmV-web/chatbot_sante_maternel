<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Prendre un Rendez-vous - MATERNUM & INFANS</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;600;800&family=Poppins:wght@300;600;800&display=swap" rel="stylesheet">

  <!-- Bootstrap + FontAwesome -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>

  <style>
    :root{
      --turquoise: #2AC7C9;
      --cyan: #4FC3E8;
      --vert-clair: #7BE495;
      --bleu-marine: #183153;
      --orange: #FFB86C;
      --bg-soft: #F7FBFA;
      --card-radius: 16px;
      --btn-radius: 999px;
      --shadow-md: 0 10px 26px rgba(24,49,83,0.06);
    }

    /* Base layout & typography */
    html,body{
      width:100%;
      height:100%;
      margin:0;
      padding:0;
      box-sizing:border-box;
      overflow-x:hidden;
      background: linear-gradient(180deg, #f4fbfb 0%, #f8fdfd 100%);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font-family: "Poppins", "Nunito", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color:var(--bleu-marine);
    }
    *, *::before, *::after { box-sizing: inherit; }

    /* Page wrapper to keep footer at bottom */
    .page-wrapper { min-height: 100vh; display:flex; flex-direction:column; }
    main.content { flex: 1 0 auto; padding: 24px 16px; }

    footer {
      flex-shrink: 0;
      background:#fff;
      padding:18px;
      text-align:center;
      color:#6b7a94;
      font-size:14px;
    }

    /* Card / form */
    .card-wrap{
      max-width: 720px;
      margin: 4vh auto;
      padding: 22px;
      border-radius: var(--card-radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.98), #fff);
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(24,49,83,0.03);
    }
    .card-wrap h3 { font-weight:800; color:var(--bleu-marine); margin-bottom:18px; }

    .form-control {
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(24,49,83,0.06);
    }

    textarea.form-control { min-height:120px; }

    .btn-pill { border-radius: var(--btn-radius); padding: 10px 18px; font-weight:700; }
    .btn-primary.btn-pill {
      background: linear-gradient(90deg,var(--turquoise), #0babae);
      border: none;
      color: #043238;
      box-shadow: 0 10px 24px rgba(42,199,201,0.10);
    }
    .btn-primary:disabled { opacity:.75; cursor:not-allowed; }

    .form-text { color:#6b7a94; }
    .feedback { margin-top:14px; min-height:40px; }

    /* Floating actions basics (kept light — _floating_menu handles markup) */
    .floating-menu{ position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:12px; align-items:flex-end; z-index:9999; }
    .mini-menu { display:none; }

    @media (max-width:680px){
      .card-wrap{ margin: 4vh 12px; padding:16px; }
    }
  </style>
</head>

<body>
  <div class="page-wrapper">
    <main class="content" role="main">
      <div class="card-wrap" role="region" aria-labelledby="pageTitle">
        <h3 id="pageTitle" class="text-center">Prendre un Rendez-vous</h3>

        <form id="appointmentForm" novalidate autocomplete="off" aria-describedby="feedback" role="form">
          <div class="form-row">
            <div class="form-group col-md-8">
              <label for="phone_number">Numéro de téléphone</label>
              <input type="tel" id="phone_number" class="form-control" name="phone_number" placeholder="+2265412XXXX" required aria-required="true" />
              <small class="form-text text-muted">Format international recommandé (ex: +2265412XXXX).</small>
            </div>

            <div class="form-group col-md-4">
              <label for="appointment_date">Date</label>
              <input type="date" id="appointment_date" class="form-control" name="appointment_date" required aria-required="true" />
            </div>
          </div>

          <div class="form-group">
            <label for="description">Description (motif)</label>
            <textarea id="description" class="form-control" name="description" rows="4" placeholder="Ex : consultation prénatale..." required aria-required="true"></textarea>
          </div>

          <div class="form-group">
            <label for="appointment_time">Heure (optionnelle)</label>
            <input type="time" id="appointment_time" class="form-control" name="appointment_time" value="09:00" />
          </div>

          <button type="submit" id="submitBtn" class="btn btn-primary btn-block btn-pill" aria-busy="false" aria-live="polite">
            <span id="btnText">Prendre Rendez-vous</span>
            <span id="btnSpinner" class="spinner-border spinner-border-sm" style="display:none;" role="status" aria-hidden="true"></span>
          </button>

          <div id="feedback" class="feedback" role="status" aria-live="polite"></div>
        </form>
      </div>
    </main>

    <footer>
      &copy; 2025 MATERNUM &amp; INFANS — Tous droits réservés.
    </footer>

    <!-- Floating Menu (sécurisé / masque la page courante) -->
    {% include '_floating_menu.html' %}
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    (function(){
      const PHONE_RE = /^\+?\d{8,15}$/;

      function showFeedback(type, text) {
        const el = document.getElementById('feedback');
        if (!el) return;
        const cls = (type === 'success') ? 'alert alert-success' : 'alert alert-danger';
        el.innerHTML = '<div class="'+cls+'">'+text+'</div>';
      }

      function isFutureDate(dateStr) {
        if (!dateStr) return false;
        const d = new Date(dateStr);
        const today = new Date(); today.setHours(0,0,0,0);
        return d >= today;
      }

      const form = document.getElementById('appointmentForm');
      if (!form) return;

      form.addEventListener('submit', async function(e){
        e.preventDefault();
        showFeedback('',''); // clear

        const phoneEl = document.getElementById('phone_number');
        const dateEl = document.getElementById('appointment_date');
        const timeEl = document.getElementById('appointment_time');
        const descEl = document.getElementById('description');
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');

        if (!phoneEl || !dateEl || !descEl || !btn || !btnText || !btnSpinner) return;

        const phone = (phoneEl.value || '').trim();
        const date = (dateEl.value || '').trim();
        const time = (timeEl && timeEl.value) ? timeEl.value : '09:00';
        const description = (descEl.value || '').trim();

        if (!phone || !date || !description) {
          showFeedback('error', 'Veuillez remplir tous les champs obligatoires.');
          return;
        }
        if (!PHONE_RE.test(phone)) {
          showFeedback('error', 'Format du numéro invalide. Ex: +2265412XXXX.');
          return;
        }
        if (!isFutureDate(date)) {
          showFeedback('error', 'Veuillez choisir une date égale ou postérieure à aujourd\'hui.');
          return;
        }

        // UI: disable and spinner
        btn.disabled = true;
        btn.setAttribute('aria-busy', 'true');
        btnText.style.display = 'none';
        btnSpinner.style.display = 'inline-block';

        try {
          const resp = await fetch('/schedule_appointment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              phone_number: phone,
              appointment_date: date,
              appointment_time: time,
              description: description
            })
          });

          let data = {};
          try { data = await resp.json(); } catch (err) { /* ignore parse error */ }

          if (!resp.ok) {
            // If server returned JSON error object, show it. If 401/redirect, give generic message.
            const errMsg = data && (data.error || data.message) ? (data.error || data.message) :
                           (resp.status === 401 ? 'Veuillez vous connecter pour effectuer cette action.' : 'Erreur serveur. Réessayez.');
            showFeedback('error', errMsg);
            return;
          }

          showFeedback('success', data.message || 'Rendez-vous enregistré avec succès !');
          form.reset();
        } catch (err) {
          console.error('schedule_appointment error:', err);
          showFeedback('error', 'Erreur réseau. Réessayez plus tard.');
        } finally {
          btn.disabled = false;
          btn.setAttribute('aria-busy', 'false');
          btnText.style.display = '';
          btnSpinner.style.display = 'none';
        }
      });
    })();
  </script>
</body>
</html>
